name: nuget

on:
  push:
    tags:
      - 'release/*'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      release:
        type: boolean
        default: false
        required: false
        description: "Release? If true, publish to nuget.org"

jobs:
  test:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: |
            8.0.x
            9.0.x
            10.0.x

      - name: dotnet test
        run: dotnet test

  pack:
    runs-on: ubuntu-latest
    needs: [test]
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: |
            8.0.x
            9.0.x
            10.0.x

      - name: Compute version suffix (non-main only)
        run: |
          # For workflow_dispatch on branches: github.ref_name is the branch
          # For push tags: github.ref_type == "tag" (no suffix)
          # For pull_request: ref is refs/pull/... (treat as non-main => suffix)
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "VERSION_SUFFIX=preview.${{ github.run_id }}" >> "$GITHUB_ENV"
          elif [[ "${{ github.ref_type }}" == "branch" && "${{ github.ref_name }}" != "main" ]]; then
            echo "VERSION_SUFFIX=preview.${{ github.run_id }}" >> "$GITHUB_ENV"
          fi

      - name: dotnet pack
        run: |
          EXTRA_ARGS=""
          if [[ -n "${VERSION_SUFFIX:-}" ]]; then
            EXTRA_ARGS="--version-suffix $VERSION_SUFFIX"
          fi

          dotnet pack Braze.Api --configuration Release $EXTRA_ARGS

      - name: upload nupkg
        uses: actions/upload-artifact@v4
        with:
          name: nuget
          path: Braze.Api/bin/Release/Braze.Api*.nupkg

  push-nuget:
    if: ${{ inputs.release || startsWith(github.ref, 'refs/tags/release/') }}
    runs-on: ubuntu-latest
    needs: [pack]
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: nuget

      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: |
            10.0.x

      - name: Push to nuget.org
        run: dotnet nuget push "./Braze.Api*.nupkg" --api-key "${{ secrets.NUGET_TOKEN }}" --source "https://api.nuget.org/v3/index.json"
